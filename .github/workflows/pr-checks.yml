name: Pull Request Checks

on:
  workflow_dispatch: # Exécution manuelle uniquement

env:
  NODE_VERSION: "18"

jobs:
  pr-checks:
    name: "PR Quality Checks"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install backend dependencies
        run: cd backend && npm ci

      - name: Lint frontend
        id: lint-frontend
        run: npm run lint

      - name: Lint backend
        id: lint-backend
        run: cd backend && npm run lint

      - name: Format check
        id: format-frontend
        run: npm run format:check

      - name: Format check backend
        id: format-backend
        run: cd backend && npm run format:check

      - name: Type check frontend
        id: typecheck-frontend
        run: npx tsc --noEmit

      - name: Type check backend
        id: typecheck-backend
        run: cd backend && n npx tsc --noEmit

      - name: Test frontend
        id: test-frontend
        run: npm run test:run

      - name: Test backend
        id: test-backend
        run: cd backend && npm run test:run

      - name: Build check frontend
        id: build-frontend
        run: npm run build

      - name: Build check backend
        id: build-backend
        run: cd backend && npm run build

      - name: Comment PR with results
        uses: actions/github-script@v7
        if: always() && github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { execSync } = require('child_process');

            let coverage = 'N/A';
            let allTestsPassed = true;

            try {
              const testOutput = execSync('npm run test:run -- --coverage --watchAll=false').toString();
              const coverageMatch = testOutput.match(/All files[^|]*\|[^|]*\|[^|]*\|[^|]*\|[^|]*\n[^|]*\|[^|]*\|([^|]*)\|/);
              coverage = coverageMatch ? coverageMatch[1].trim() : 'N/A';
            } catch (error) {
              console.log('Could not extract coverage:', error);
              allTestsPassed = false;
            }


            const commentBody = `
            ## ${allTestsPassed ? '✅' : '❌'} Pull Request Checks Results

            - **Coverage:** ${coverage}
            - **Tests:** ${allTestsPassed ? '✅ Passed' : '❌ Failed'}

            [View CI Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `;

            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            } catch (error) {
              console.log('Failed to create comment:', error);
            }
